{% extends "main/base.html" %}
{% load static %}

{% block content %}
<style>
    .combo-container {
        max-width: 800px;
        margin: 20px auto;
        padding: 25px;
        background: #fff9f9;
        border-radius: 15px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .selection-card {
        display: flex;
        align-items: center;
        padding: 15px;
        margin: 10px 0;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        cursor: pointer;
        border: 2px solid transparent;
    }
    
    .selection-card:hover {
        border-color: #d63384;
    }
    
    .selection-card.selected {
        border-color: #d63384;
        background-color: #fff0f6;
    }
    
    .selection-image {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 8px;
        margin-right: 15px;
    }
    
    .selection-details {
        flex-grow: 1;
    }
    
    .selection-name {
        font-weight: 500;
        margin-bottom: 5px;
    }
    
    .selection-price {
        color: #d63384;
        font-weight: 600;
    }
    
    .qty-control {
        display: flex;
        align-items: center;
        margin-left: 15px;
    }
    
    .qty-btn {
        width: 30px;
        height: 30px;
        background: #d63384;
        color: white;
        border: none;
        border-radius: 5px;
        font-size: 16px;
        cursor: pointer;
    }
    
    .qty-input {
        width: 50px;
        text-align: center;
        margin: 0 5px;
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 5px;
    }
    
    .duration-selector {
        margin: 20px 0;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        width: 100%;
    }
    
    .total-section {
        text-align: right;
        margin: 30px 0;
        padding-top: 20px;
        border-top: 1px dashed #ddd;
        font-size: 20px;
    }
    
    .submit-btn {
        width: 100%;
        padding: 12px;
        background: #d63384;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 18px;
        font-weight: 600;
        cursor: pointer;
    }
</style>

<div class="combo-container">
    <h1>Shanti Combo</h1>
    
    <form method="POST">
        {% csrf_token %}
        <input type="hidden" name="massage_price" id="massage_price" value="0">
        <input type="hidden" name="yoga_price" id="yoga_price" value="0">
        
        <!-- Products Section -->
        <h2>Products</h2>
        {% for product in products %}
        <div class="selection-card">
            <img src="{{ product.image.url }}" class="selection-image" alt="{{ product.name }}">
            <div class="selection-details">
                <div class="selection-name">{{ product.name }}</div>
                <div class="selection-price">Rs. {{ product.price }}</div>
            </div>
            <div class="qty-control">
                <button type="button" class="qty-btn" onclick="updateQty('{{ product.id }}', -1)">-</button>
                <input type="text" class="qty-input" id="qty_{{ product.id }}" 
                       name="product_{{ product.id }}" value="0" readonly>
                <button type="button" class="qty-btn" onclick="updateQty('{{ product.id }}', 1)">+</button>
            </div>
        </div>
        {% endfor %}

        <!-- Massage Service Section -->
        <h2>Massage Service</h2>
        {% for key, option in massage_options.items %}
        <div class="selection-card service-massage {% if key == 'none' %}selected{% endif %}" 
             onclick="selectService('massage', '{{ key }}')">
            {% if key != 'none' %}
            <img src="{{ option.image }}" class="selection-image" alt="Massage {{ key }}">
            {% endif %}
            <div class="selection-details">
                <div class="selection-name">
                    {% if key == 'none' %}No Massage{% else %}{{ key }}{% endif %}
                </div>
                {% if key != 'none' %}
                <div class="selection-price">Rs. {{ option.price }}/day</div>
                {% endif %}
            </div>
        </div>
        {% endfor %}

        <div class="duration-selector" id="massage_duration">
            <select name="massage_days" id="massage_days" onchange="updateTotal()">
                <option value="0">Select days</option>
                <option value="3">3 Days</option>
                <option value="7">7 Days</option>
            </select>
        </div>
        <input type="hidden" name="massage_type" id="massage_type" value="none">

        <!-- Yoga Service Section -->
        <h2>Yoga & Meditation</h2>
        {% for key, option in yoga_options.items %}
        <div class="selection-card service-yoga {% if key == 'none' %}selected{% endif %}" 
             onclick="selectService('yoga', '{{ key }}')">
            {% if key != 'none' %}
            <img src="{{ option.image }}" class="selection-image" alt="Yoga {{ key }}">
            {% endif %}
            <div class="selection-details">
                <div class="selection-name">
                    {% if key == 'none' %}No Yoga{% else %}{{ key }}{% endif %}
                </div>
                {% if key != 'none' %}
                <div class="selection-price">Rs. {{ option.price }}/day</div>
                {% endif %}
            </div>
        </div>
        {% endfor %}

        <div class="duration-selector" id="yoga_duration">
            <select name="yoga_days" id="yoga_days" onchange="updateTotal()">
                <option value="0">Select days</option>
                <option value="3">3 Days</option>
                <option value="7">7 Days</option>
            </select>
        </div>
        <input type="hidden" name="yoga_type" id="yoga_type" value="none">
        
        <!-- Payment Method -->
        <div class="payment-method">
            <h3>Payment Method</h3>
            <select name="payment_method" required>
                <option value="">-- Select Payment Method --</option>
                <option value="COD">Cash on Delivery (COD)</option>
                <option value="BANK_NIC">Bank Transfer (NIC Asia)</option>
            </select>
        </div>
        
        <!-- Order Summary -->
        <div class="total-section">
            <strong>Total: Rs. <span id="total">0.00</span></strong>
        </div>
        
        <button type="submit" class="submit-btn">Place Order</button>
    </form>
</div>

<script>
    // Define prices
    const prices = {
        products: {
            {% for product in products %}
            '{{ product.id }}': {{ product.price }},
            {% endfor %}
        },
        massage: {
            {% for key, option in massage_options.items %}
            {% if key != 'none' %}'{{ key }}': {{ option.price }},{% endif %}
            {% endfor %}
        },
        yoga: {
            {% for key, option in yoga_options.items %}
            {% if key != 'none' %}'{{ key }}': {{ option.price }},{% endif %}
            {% endfor %}
        }
    };

    // Quantity update function
    function updateQty(productId, change) {
        const input = document.getElementById(`qty_${productId}`);
        let newValue = parseInt(input.value) + change;
        newValue = Math.max(0, newValue);
        input.value = newValue;
        updateTotal();
    }

    // Service selection function
    function selectService(type, value) {
        // Update hidden input
        document.getElementById(`${type}_type`).value = value;
        
        // Update UI selection
        document.querySelectorAll(`.service-${type}`).forEach(card => {
            card.classList.remove('selected');
        });
        event.currentTarget.classList.add('selected');
        
        // Show/hide duration selector
        const durationEl = document.getElementById(`${type}_duration`);
        durationEl.style.display = value === 'none' ? 'none' : 'block';
        
        updateTotal();
    }

    // Total calculation function
    function updateTotal() {
        let total = 0;
        
        // Calculate products total
        for (const id in prices.products) {
            total += (parseInt(document.getElementById(`qty_${id}`).value) || 0) * prices.products[id];
        }
        
        // Calculate massage total
        const massageType = document.getElementById('massage_type').value;
        if (massageType !== 'none') {
            const massageDays = parseInt(document.getElementById('massage_days').value || 0);
            total += prices.massage[massageType] * massageDays;
        }
        
        // Calculate yoga total
        const yogaType = document.getElementById('yoga_type').value;
        if (yogaType !== 'none') {
            const yogaDays = parseInt(document.getElementById('yoga_days').value || 0);
            total += prices.yoga[yogaType] * yogaDays;
        }
        
        document.getElementById('total').textContent = total.toFixed(2);
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Set default selections
        document.getElementById('massage_type').value = 'none';
        document.getElementById('yoga_type').value = 'none';
        
        // Hide duration selectors by default
        document.getElementById('massage_duration').style.display = 'none';
        document.getElementById('yoga_duration').style.display = 'none';
    });
</script>
{% endblock %}